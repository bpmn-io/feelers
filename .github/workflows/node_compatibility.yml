name: Node Compatibility

on:
  schedule:
    - cron: "0 2 * * 1"
  workflow_dispatch:

jobs:
  check_age:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - uses: actions/github-script@v7
        id: check
        with:
          script: |
            const { data: commits } = await github.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: 'main',
              per_page: 1
            });

            if (!commits.length) {
              core.setOutput('should-run', 'false');
              return;
            }

            const last = new Date(commits[0].commit.committer.date).getTime();
            const sevenDays = 7 * 24 * 60 * 60 * 1000;

            core.setOutput(
              'should-run',
              Date.now() - last <= sevenDays ? 'true' : 'false'
            );

  test:
    needs: check_age
    if: needs.check_age.outputs.should-run == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
        node-version: [20.x, 22.x]

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - run: npm ci
      - uses: bpmn-io/actions/setup@latest
      - run: npm run lint
      - run: npm run build
      - run: npm run test:ci
      - run: npm run generate:parser
      - run: npm run bundle
